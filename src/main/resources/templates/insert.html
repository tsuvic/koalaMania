<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"
	content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
<meta name="generator" content="Hugo 0.79.0">
<title>koalaMania</title>

<link rel="canonical"
	href="https://getbootstrap.jp/docs/5.0/examples/starter-template/">
<!-- Bootstrap core CSS -->
<link
	href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css
	rel="stylesheet"
	integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
	crossorigin="anonymous">

<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>

<!-- Custom styles for this template -->
<link href="/css/starter-template.css" rel="stylesheet">
<title th:text="${title}">Insert title here</title>
<script type="text/javascript">
	function isAliveFlag($this) {
		const isAliveFlag = $this.value;
		if (isAliveFlag == 1) {
			document.getElementById("deathYear").disabled = true;
			document.getElementById("deathMonth").disabled = true;
			document.getElementById("deathDay").disabled = true;
			document.getElementById("deathYear").value = 0;
			document.getElementById("deathMonth").value = 0;
			document.getElementById("deathDay").value = 0;

		} else {
			document.getElementById("deathYear").disabled = false;
			document.getElementById("deathMonth").disabled = false;
			document.getElementById("deathDay").disabled = false;
			document.getElementById("deathYear").value = "2000";
			document.getElementById("deathMonth").value = "1";
			document.getElementById("deathDay").value = "1";
		}
	}

	let doubleClick = false;

	function validateSubmit($this) {

		if (doubleClick) {
			return false;
		}

		let nameFlag = true;
		if (!$this.elements["name"].value) {
			alert('名前を入力してください。');
			nameFlag = false;
		}

		const birthYear = $this.elements["birthYear"].value;
		const birthMonth = $this.elements["birthMonth"].value;
		const birthDay = $this.elements["birthDay"].value;
		const deathYear = $this.elements["deathYear"].value;
		const deathMonth = $this.elements["deathMonth"].value;
		const deathDay = $this.elements["deathDay"].value;
		const birth = [ birthYear, birthMonth, birthDay ];
		const death = [ deathYear, deathMonth, deathDay ];

		let birthZeroCount = 0;
		for (let i = 0; i < birth.length; i++) {
			if (birth[i] == 0) {
				birthZeroCount++;
			}
		}

		let deathZeroCount = 0;
		for (let i = 0; i < death.length; i++) {
			if (death[i] == 0) {
				deathZeroCount++;
			}
		}

		let birthFlag = true;
		if (1 <= birthZeroCount && birthZeroCount <= 2) {
			alert('生年月日が不正です。');
			birthFlag = false;
		}

		const birthDate = zeroPadding(birthYear, birthMonth, birthDay);
		let deathDate = zeroPadding(deathYear, deathMonth, deathDay);
		if (deathDate == 00000000) {
			deathDate = 99990101;
		}

		let deathFlag = true;
		if ((1 <= deathZeroCount && deathZeroCount <= 2)
				|| (birthDate > deathDate)) {
			alert('死亡日が不正です。');
			deathFlag = false;
		}

		let detailsFlag = true;
		if (!$this.elements["details"].value) {
			alert('詳細を入力してください。');
			detailsFlag = false;
		}

		let featureFlag = true;
		if (!$this.elements["feature"].value) {
			alert('特徴を入力してください。');
			featureFlag = false;
		}

		if (nameFlag && birthFlag && deathFlag && detailsFlag && featureFlag) {
			document.getElementById('submitButton').textContent = "保存中....";
			doubleClick = true;
			return true;
		} else {
			return false;
		}
	}

	function zeroPadding(year, month, day) {
		let intYear = ("0000" + parseInt(year)).slice(-4);
		let intMonth = ("00" + parseInt(month)).slice(-2);
		let intDay = ("00" + parseInt(day)).slice(-2);

		return parseInt("" + intYear + intMonth + intDay);
	}
	
	function deleteFunc(animal_id, thisButton) {
		const deleteFalg = confirm('このコアラを削除してもよろしいですか？');
		if (deleteFalg) {
			thisButton.disabled = true;
			thisButton.previousElementSibling.disabled = true;
			thisButton.nextElementSibling.disabled = true;
			location.href = '/delete/' + animal_id;
		} else {
			return;
		}
	}

	$(function() {
		$('.addInputFileButton').click(function(e) {
			const input = $("#animalImage").clone(true);
			const cancelButton = $('#cancelInputFileButton').clone(true);
			input.val("");
			input.appendTo("#animalImages");
			cancelButton.appendTo("#animalImages");
			$("#animalImages").append("<br>");
		});
	
		$('#cancelInputFileButton').click(function() {
			const contents = $("#animalImages > input").length;
			if (contents > 1) {
				$(this).prev().remove();
				$(this).next().remove();
				$(this).remove();
			} 
		});
	});

	$(function() {
		$('.addHistoryButton').click(function(e) {
			const input = $("#zooHistoryDiv").clone(true);
			input.val("");
			input.appendTo("#zooHistory");
		});
	});

	$(function() {
		$('.cancelHistoryButton').click(function(e) {
			const contents = $("#zooHistory > #zooHistoryDiv").length;
			if (contents > 1) {
				$(this).parent().remove();
			} else {
				$(this).prev().val("");
			}
		});

		$('.deleteImageButton').click(function(e) {
			const deleteImageFalg = confirm('この写真を削除してもよろしいですか？');
			if (!deleteImageFalg) {
				return;
			}
			let animalImageId = $(this).parent().attr("id");
			let deleteIds = $('#deleteAnimalImageFiles').val();
			if (!deleteIds) {
				deleteIds = animalImageId;
			} else {
				deleteIds += ',' + animalImageId;
			}
			$('#deleteAnimalImageFiles').val(deleteIds);
			$(this).parent('span').remove();
		});
	})
</script>

</head>

<div th:replace="~{block/header_boot::headerA_boot}"></div>


<body>

	<div class="container">
		<h1 th:text="${title}">タイトル</h1>
		<!--タイトル名を 変数式でControllerから取得 -->


		<form th:action="@{/insert}" method="post"
			enctype="multipart/form-data" th:object="${animalInsertForm}"
			onsubmit="return validateSubmit(this);">
			<input th:unless="*{animal_id}==0" type="hidden"
				th:field="*{animal_id}"> <input type="hidden"
				th:field="*{profileImagePath}"> プロフィール写真：<br> <span
				th:id="*{profileImagePath}" th:if="*{profileImagePath}"> <img
				th:src="*{profileImagePath}" width="200" height="200">
				<button class="btn btn-danger btn-sm deleteImageButton"
					type="button">削除</button>
			</span>
			<div id="animalProfileImageUpload">
				<input type="file" accept="image/*"
					th:field="*{animalProfileImageUpload}" th:errorclass="is-invalid"
					class="form-control-file">
				<button class="btn btn-outline-warning btn-sm"
					id="cancelInputFileButton" type="button">写真取消</button>
				<br>
			</div>

			<div class="form-group">
				名前：<input type="text" class="form-control" th:field="*{name}"
					th:errorclass="is-invalid" />
				<div class="invalid-feedback" th:errors="*{name}"></div>
			</div>
			<div class="form-group">
				性別：<select th:field="*{sex}">
					<option th:each="item : ${sexItems}" th:value="${item.key}"
						th:text="${item.value}"></option>
				</select>
			</div>

			<div class="form-group">
				生年月日：<select th:field="*{birthYear}">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(1990, 2021)}"
						th:value="${i}" th:text="${i}"></option>
				</select>年 <select th:field="*{birthMonth}">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}"
						th:text="${i}"></option>
				</select>月 <select th:field="*{birthDay}">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(1, 31)}" th:value="${i}"
						th:text="${i}"></option>
				</select>日
			</div>
			<div class="form-group">
				母親：<select th:field="*{mother_id}" th:errorclass="is-invalid">
					<!-- id とnameはform用 -->
					<option th:each="mother : ${motherList}"
						th:value="${mother.animal_id}" th:text="${mother.name}"></option>
				</select> 父親：<select th:field="*{father_id}" th:errorclass="is-invalid">
					<option th:each="father : ${fatherList}"
						th:value="${father.animal_id}" th:text="${father.name}"></option>
				</select>
			</div>
			<div th:id="zooHistory">
				<div th:id="zooHistoryDiv" th:each="animalZoo : *{animalZooHistory}" th:object="${animalZoo}">
					<div class="form-group" id="zooForm">
						動物園：<select th:name="insertZoo" >
							<option th:each="zoo : ${zooList}" th:value="${zoo.zoo_id}" th:text="${zoo.zoo_name}" th:selected="${animalInsertForm.animalZooHistory[__${animalZooStat.index}__].zoo_id} == ${zoo.zoo_id}"></option>
							<!--fieldは送信先のフォームクラスの変数、 each は繰り返し、valueはフォームで送信する実際の値、textはHTMLに表示される名前 -->
						</select>
						<!-- <div class="invalid-feedback" th:errors="*{zooList}"></div> -->
					</div>

					<div class="form-group" th:id="admissionForm">入園日：
						<select  th:name="admissionYear">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1990, 2021)}" th:value="${i}" th:text="${i}"  th:selected="*{#dates.year(admission_date)} == ${i}"></option></select>年 
						<select th:if = "*{#dates.year(admission_date)} == '9999'" th:name="admissionMonth">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}" th:text="${i}" ></option></select>
						<select th:unless = "*{#dates.year(admission_date)} == '9999'" th:name="admissionMonth">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}" th:text="${i}" th:selected="*{#dates.month(admission_date)} == ${i}"></option></select>月 
						<select th:if = "*{#dates.year(admission_date)} == '9999'" th:name="admissionDay">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 31)}" th:value="${i}" th:text="${i}"></option></select>
						<select th:unless = "*{#dates.year(admission_date)} == '9999'" th:name="admissionDay">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 31)}" th:value="${i}" th:text="${i}" th:selected="*{#dates.day(admission_date)} == ${i}"></option></select>日
					</div>

					<div class="form-group" th:id="exitForm">退園日：
						<select th:name="exitYear">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1990, 2021)}" th:value="${i}" th:text="${i}" th:selected="*{#dates.year(exit_date)} == ${i}"></option></select>年
						<select th:name="exitMonth" th:if = "*{#dates.year(exit_date)} == '9999'">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}" th:text="${i}" ></option></select>
							<select th:name="exitMonth" th:unless = "*{#dates.year(exit_date)} == '9999'">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}" th:text="${i}" th:selected="*{#dates.month(exit_date)} == ${i}"></option></select>月
						<select th:name="exitDay" th:if = "*{#dates.year(exit_date)} == '9999'">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 31)}" th:value="${i}" th:text="${i}" ></option></select>
							<select th:name="exitDay" th:unless = "*{#dates.year(exit_date)} == '9999'">
							<option value="0">--</option>
							<option th:each="i : ${#numbers.sequence(1, 31)}" th:value="${i}" th:text="${i}" th:selected="*{#dates.day(exit_date)} == ${i}"></option></select>日
					</div>
					
					<button class="btn btn-outline-warning btn-sm cancelHistoryButton"
						type="button">動物園削除</button>
				</div>
			</div>
			<button class="btn btn-outline-success btn-sm addHistoryButton"
				type="button">動物園追加</button>

			<div class="form-group">
				生死：<select th:field="*{is_alive}" onchange="isAliveFlag(this);">
					<option th:each="item : ${isAliveItems}" th:value="${item.key}"
						th:text="${item.value}"></option>
				</select>
			</div>
			<div class="form-group">
				死亡日：<select th:field="*{deathYear}" th:disabled="*{is_alive} == 1">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(1990, 2021)}"
						th:value="${i}" th:text="${i}" th:selected="${i}==2000"></option>
				</select>年 <select th:field="*{deathMonth}" th:disabled="*{is_alive} == 1">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(01, 12)}" th:value="${i}"
						th:text="${i}"></option>
				</select>月 <select th:field="*{deathDay}" th:disabled="*{is_alive} == 1">
					<option value="0">--</option>
					<option th:each="i : ${#numbers.sequence(01, 31)}" th:value="${i}"
						th:text="${i}"></option>
				</select>日
			</div>
			<div class="form-group">
				詳細：
				<textarea class="form-control" th:field="*{details}"
					th:errorclass="is-invalid"></textarea>
				<div class="invalid-feedback" th:errors="*{details}"></div>
			</div>
			<div class="form-group">
				特徴：
				<textarea class="form-control" th:field="*{feature}"
					th:errorclass="is-invalid"></textarea>
				<div class="invalid-feedback" th:errors="*{feature}"></div>
			</div>
			<div class="form-group">
				写真：<br> <span th:unless="*{animalImageList.size} == 0"
					th:each="animalImage:*{animalImageList}" th:object="${animalImage}"
					th:id="*{animalimage_id} + *{filetype}"
					style="display: inline-block"> <img
					th:src="@{{cloudinaryImageUrl}{animal_id}/{fileName}(cloudinaryImageUrl = ${cloudinaryImageUrl},animal_id=${animalInsertForm.animal_id},fileName=*{animalimage_id} + *{filetype})}"
					width="200" height="200">
					<button class="btn btn-danger btn-sm deleteImageButton"
						type="button">削除</button>
				</span>

				<div id="animalImages">
					<input type="file" accept="image/*" th:field="*{animalImage}"
						th:errorclass="is-invalid" class="form-control-file">
					<button class="btn btn-outline-warning btn-sm"
						id="cancelInputFileButton" type="button">写真取消</button>
					<br>
				</div>
				<button class="btn btn-outline-success btn-sm addInputFileButton"
					type="button">写真追加</button>
			</div>
			<input type="hidden" th:field="*{deleteAnimalImageFiles}">
			<button th:if="*{animal_id}==0"
				class="btn btn-outline-primary btn-sm" type="submit">コアラ情報登録</button>

			<button th:unless="*{animal_id}==0"
				class="btn btn-outline-primary btn-sm" id = "submitButton" type="submit">保存</button>
			<button class="btn btn-danger btn-sm" type="button"
				th:unless="*{animal_id}==0"
				th:onclick="'deleteFunc(' + *{animal_id} + ',this);'">削除</button>
			<button class="btn btn-outline-danger btn-sm" type="button"
				onclick="location.href='/search'">一覧に戻る</button>
		</form>
	</div>

</body>


</html>